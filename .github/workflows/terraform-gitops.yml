name: Terraform GitOps

on:
  pull_request:
    branches: [ "main" ]

  workflow_dispatch:
    inputs:
      region:
        description: "AWS Region"
        required: true
        default: "us-east-1"
        type: choice
        options:
          - us-east-1
      extra_terraform_cmd:
        description: "Optional Terraform command to run (e.g., 'terraform force-unlock <LOCK_ID>')"
        required: false
        default: null
        type: string

jobs:
  terraform:
    runs-on: ubuntu-latest

    permissions:
      issues: write      # REQUIRED for manual-approval action
      contents: read
      actions: read
      id-token: write    # REQUIRED for AWS OIDC authentication

    steps:
      # ---------------------------
      # Checkout
      # ---------------------------
      - name: Checkout
        uses: actions/checkout@v3

      # ---------------------------
      # Setup Terraform
      # ---------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      # ---------------------------
      # Configure AWS
      # ---------------------------
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.TERRAFORM_GITHUB_ACTIONS_ROLE_ARN }}
          aws-region: ${{ github.event.inputs.region || 'us-east-1' }}

      # ---------------------------
      # Determine env + region
      # ---------------------------
      - name: Set variables
        id: vars
        run: |
          # Detect env based on branch
          ENV="dev"

          if [[ "${GITHUB_REF##*/}" == "main" ]]; then
            ENV="prod"
          fi
          if [[ "$GITHUB_EVENT_NAME" == "pull_request" && "$GITHUB_BASE_REF" == "main" ]]; then
            ENV="prod"
          fi

          echo "Selected environment: $ENV"

          REGION="${{ github.event.inputs.region || 'us-east-1' }}"
          FILE="${ENV}.${REGION}.tfvars"

          echo "env=$ENV" >> $GITHUB_OUTPUT
          echo "region=$REGION" >> $GITHUB_OUTPUT
          echo "tfvars_file=$FILE" >> $GITHUB_OUTPUT
          echo "Selected tfvars: $FILE"

      # ---------------------------
      # Terraform Init
      # ---------------------------
      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=aws-org-terraform-terraform-state" \
            -backend-config="key=${{ steps.vars.outputs.env }}/${{ steps.vars.outputs.region }}/terraform.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="dynamodb_table=tf-locks" \
            -backend-config="encrypt=true"

      # ---------------------------
      # Optional extra Terraform command
      # ---------------------------
      - name: Run Extra Terraform Command
        if: ${{ github.event.inputs.extra_terraform_cmd != null && github.event.inputs.extra_terraform_cmd != '' }}
        run: |
          echo "Running extra Terraform command: ${{ github.event.inputs.extra_terraform_cmd }}"
          ${{ github.event.inputs.extra_terraform_cmd }}            

      # ---------------------------
      # Terraform Plan (all branches)
      # ---------------------------
      - name: Terraform Plan
        run: |
          terraform plan \
            -var-file="environments/${{ steps.vars.outputs.tfvars_file }}" \
            -out="tfplan"

      # Upload plan for PR or logs
      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: tfplan   

      # ---------------------------
      # Manual approval ONLY on main before apply
      # ---------------------------
      - name: Manual Approval
        if: github.ref == 'refs/heads/main'
        uses: trstringer/manual-approval@v1.12.0
        with:
          secret: ${{ github.TOKEN }}
          approvers: "${{ github.repository_owner }}"
          minimum-approvals: 1

          issue-title: "Approve Apply | Env: ${{ steps.vars.outputs.env }} | Region: ${{ steps.vars.outputs.region }} | Run ID: ${{ github.run_id }}"
          issue-body: |
            **Terraform Apply Requested**

            **Environment:** ${{ steps.vars.outputs.env }}
            **Region:** ${{ steps.vars.outputs.region }}
            **Run ID:** ${{ github.run_id }}
            **tfvars File:** $${{ steps.vars.outputs.tfvars_file }}
            **actor:** ${{ github.actor }}
            **triggered by:** ${{ github.event_name }}
            **triggered actor:** ${{ github.triggering_actor }}

            Only **${{ github.repository_owner }}** can approve this deployment.

      # ---------------------------
      # Terraform Apply (only on main)
      # ---------------------------
      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
